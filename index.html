<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ú†Øª Ø¨Ø§Øª Ø¢ÙˆØ§Ø¬ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øªâ€ŒÙ‡Ø§</title>
<style>
body{margin:0; font-family:sans-serif;}
#avaj-chat-box{
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    width:420px; height:600px; border-radius:14px; display:flex;
    flex-direction:column; overflow:hidden; z-index:9999999;
    box-shadow:0 4px 12px rgba(0,0,0,0.25);
    background-image:url('https://static.vecteezy.com/system/resources/previews/026/757/331/non_2x/books-seamless-pattern-on-craft-paper-background-with-hand-drawn-elements-doodles-for-wrapping-paper-scrapbooking-prints-packaging-wallpaper-stationary-etc-eps-10-vector.jpg');
    background-size:cover; background-position:center;
}
#avaj-top-bar{
    display:flex; justify-content:space-between; align-items:center;
    padding:6px 12px; background:rgba(255,255,255,0.8); backdrop-filter:blur(6px);
}
#avaj-back-btn,#avaj-history-btn,#avaj-fullscreen-btn{
    padding:4px 8px; border:none; border-radius:6px; cursor:pointer; font-size:12px;
}
#avaj-back-btn{background:#7A6A52; color:#fff;}
#avaj-history-btn{background:#BDAA8C; color:#fff; margin:0 6px;}
#avaj-fullscreen-btn{background:#B89B72; color:#fff;}
#avaj-messages{
    flex:1; padding:12px; overflow-y:auto; display:flex;
    flex-direction:column; gap:8px; margin-top:0;
}
.avaj-msg{ padding:8px 12px; border-radius:10px;
    max-width:70%; word-break: break-word; background:rgba(255,255,255,0.7);
    backdrop-filter:blur(6px);
}
.avaj-user{align-self:flex-end;}
.avaj-bot{align-self:flex-start;}
#avaj-inputArea{ display:flex; padding:8px; background:rgba(255,255,255,0.7); backdrop-filter:blur(8px);}
#avaj-text{ flex:1; padding:6px; border-radius:6px; border:1px solid #BDAA8C; background:#ffffffcc; outline:none;}
#avaj-send{ padding:6px 14px; background:#B89B72; color:#fff; border:none; border-radius:6px; cursor:pointer;}
#avaj-footer{ text-align:center; padding:4px; font-size:12px; color:#5A4A3A; background:rgba(255,255,255,0.7); border-top:1px solid #C9B79A;}
#avaj-chat-box.fullscreen{ top:0; left:0; transform:none; width:100vw; height:100vh; border-radius:0;}
#avaj-chat-box.fullscreen #avaj-messages{ margin-top:0;}
.typing-dots{ display:flex; gap:4px; align-items:center; height:20px;}
.typing-dot{ width:6px; height:6px; background:#7A6A52; border-radius:50%; animation:dot-bounce 1.2s infinite;}
.typing-dot:nth-child(2){animation-delay:0.2s;}
.typing-dot:nth-child(3){animation-delay:0.4s;}
@keyframes dot-bounce{0%,100%{transform:translateY(0);}50%{transform:translateY(-6px);}}
#avaj-newchat{ margin-top:4px; padding:4px; background:#7A6A52; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:12px;}
#avaj-history-panel{
    position:absolute; top:40px; right:0; width:150px; max-height:300px;
    background:rgba(255,255,255,0.9); backdrop-filter:blur(6px); overflow-y:auto;
    display:none; flex-direction:column; z-index:99999999; border-left:1px solid #BDAA8C;
}
.history-item{ padding:6px; cursor:pointer; border-bottom:1px solid #C9B79A; font-size:12px; }
.history-item:hover{background:#BDAA8C; color:#fff;}
</style>
</head>
<body>

<div id="avaj-chat-box">
    <div id="avaj-top-bar">
        <button id="avaj-back-btn">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <button id="avaj-history-btn">ğŸ“‚ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øªâ€ŒÙ‡Ø§</button>
        <button id="avaj-fullscreen-btn">â›¶</button>
    </div>
    <div id="avaj-history-panel"></div>
    <div id="avaj-messages"></div>
    <div id="avaj-inputArea">
        <input id="avaj-text" placeholder="Ù¾ÛŒØ§Ù… Ø¨Ù†ÙˆÛŒØ³...">
        <button id="avaj-send">Ø§Ø±Ø³Ø§Ù„</button>
    </div>
    <button id="avaj-newchat">ğŸ†• Ú†Øª Ø¬Ø¯ÛŒØ¯</button>
    <div id="avaj-footer">Ù‚Ø¯Ø±Øª Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø² <b>Ø¢ÙˆØ§Ø¬</b></div>
</div>

<script>
const KEY = "Bearer sk-b855a785d191a49b634143adee34f6d2";
const URL = "https://api.talkbot.ir/v1/chat/completions";

const msgs = document.getElementById("avaj-messages");
const txt = document.getElementById("avaj-text");
const send = document.getElementById("avaj-send");
const fullscreenBtn = document.getElementById("avaj-fullscreen-btn");
const newChatBtn = document.getElementById("avaj-newchat");
const backBtn = document.getElementById("avaj-back-btn");
const historyBtn = document.getElementById("avaj-history-btn");
const historyPanel = document.getElementById("avaj-history-panel");

let fs = false;
fullscreenBtn.onclick = ()=>{ fs = !fs; document.getElementById("avaj-chat-box").classList.toggle("fullscreen"); fullscreenBtn.innerText = fs?"âœ–":"â›¶"; };
backBtn.onclick = ()=>{ window.location.href="https://avage.ir"; };

/* ---------------- Ø°Ø®ÛŒØ±Ù‡ ØªÙ…Ø§Ù… Ú†Øªâ€ŒÙ‡Ø§ ---------------- */
function getAllChats(){ return JSON.parse(localStorage.getItem("avajAllChats")||"[]"); }
function saveAllChats(chats){ localStorage.setItem("avajAllChats",JSON.stringify(chats)); }

let currentChatIndex = 0;

function saveMessage(role,text){
    let chats = getAllChats();
    if(!chats[currentChatIndex]) chats[currentChatIndex]=[];
    chats[currentChatIndex].push({role,text});
    saveAllChats(chats);
}
function loadHistory(){
    msgs.innerHTML="";
    let chats = getAllChats();
    if(!chats[currentChatIndex]) chats[currentChatIndex]=[];
    chats[currentChatIndex].forEach(msg=>{
        const bubble = document.createElement("div");
        bubble.className="avaj-msg "+(msg.role=="user"?"avaj-user":"avaj-bot");
        bubble.textContent=msg.text;
        msgs.appendChild(bubble);
    });
    msgs.scrollTop = msgs.scrollHeight;
}
loadHistory();

/* ---------------- Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ ---------------- */
function renderChatList(){
    historyPanel.innerHTML="";
    let chats = getAllChats();
    chats.forEach((chat,i)=>{
        const item = document.createElement("div");
        item.className="history-item";
        item.textContent="Ú†Øª "+(i+1);
        item.onclick=()=>{
            currentChatIndex=i;
            historyPanel.style.display="none";
            loadHistory();
        };
        historyPanel.appendChild(item);
    });
}
historyBtn.onclick=()=>{
    historyPanel.style.display = historyPanel.style.display=="flex" ? "none" : "flex";
    renderChatList();
};

/* ---------------- Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ØªØ§ÛŒÙ¾ ---------------- */
function typeWriterEffect(text, element, speed=25){
    let i=0;
    function next(){ if(i<text.length){ element.textContent+=text.charAt(i); i++; setTimeout(next,speed); } }
    next();
}
function addBotTypingMessage(text){
    const bubble=document.createElement("div");
    bubble.className="avaj-msg avaj-bot";
    msgs.appendChild(bubble);
    msgs.scrollTop = msgs.scrollHeight;
    typeWriterEffect(text,bubble);
    saveMessage("bot",text);
}
function addUserMsg(text){
    const bubble=document.createElement("div");
    bubble.className="avaj-msg avaj-user";
    bubble.textContent=text;
    msgs.appendChild(bubble);
    msgs.scrollTop = msgs.scrollHeight;
    saveMessage("user",text);
}

/* ---------------- Ù†Ù‚Ø·Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§ÛŒÙ¾ ---------------- */
function addTyping(){
    const t=document.createElement("div");
    t.className="avaj-msg avaj-bot";
    t.id="typing";
    t.innerHTML='<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
    msgs.appendChild(t);
    msgs.scrollTop=msgs.scrollHeight;
}
function removeTyping(){ const t=document.getElementById("typing"); if(t)t.remove(); }

/* ---------------- Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ---------------- */
async function sendMessage(text){
    if(!text) return;
    addUserMsg(text);
    txt.value="";
    addTyping();
    try{
        const res = await fetch(URL,{
            method:"POST",
            headers:{"Content-Type":"application/json","Authorization":KEY},
            body:JSON.stringify({model:"o3-mini-2025-01-31",messages:[{role:"user",content:text}]})
        });
        removeTyping();
        const data = await res.json();
        const answer = data?.choices?.[0]?.message?.content || "Ø®Ø·Ø§!";
        addBotTypingMessage(answer);
    }catch(e){
        removeTyping();
        addBotTypingMessage("âŒ Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯!");
    }
}

/* Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ùˆ Ø§ÛŒÙ†ØªØ± */
send.onclick = ()=>sendMessage(txt.value.trim());
txt.addEventListener("keydown",e=>{ if(e.key==="Enter") sendMessage(txt.value.trim()); });

/* ---------------- Ú†Øª Ø¬Ø¯ÛŒØ¯ ---------------- */
newChatBtn.onclick=()=>{
    let chats = getAllChats();
    chats.push([]);
    currentChatIndex = chats.length-1;
    saveAllChats(chats);
    loadHistory();
};
</script>
</body>
</html>
